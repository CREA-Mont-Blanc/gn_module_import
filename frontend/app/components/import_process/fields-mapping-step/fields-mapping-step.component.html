<div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0"> Mapping des champs </h5>
        </div>
        <div class="card-body" *ngIf="formReady">
            <!-- Choix du mapping -->
            <form [formGroup]="_fm.fieldMappingForm" class="was-validated">
                <fieldset>
                    <legend class="px-1">
                        Choix du mapping
                    </legend>
                    <div *ngIf="_fm.userFieldMappings" class="form-group">
                        <select class="form-control form-control-sm" id="mappingSelection"
                            formControlName="fieldMapping">
                            <option [value]=""></option>
                            <option *ngFor="let data of _fm.userFieldMappings" [value]="data.id_mapping">
                                {{data.mapping_label}}</option>
                        </select>
                    </div>
                    <button
                        class="btn btn-secondary btn-sm box-shadow d-flex justify-content-center align-content-between mb-3"
                        (click)="_fm.createMapping()">
                        Nouveau mapping
                    </button>
                    <div *ngIf="_fm.newMapping" class="d-flex flex-row justify-content-between form_group" id="newMap">
                        <input type="text" class="form-control mr-2" value="Inconnu" formControlName="mappingName">
                        <button class="btn btn-success box-shadow d-flex justify-content-center align-content-between mr-2"
                            (click)="_fm.saveMappingName(_fm.fieldMappingForm.value, importId, syntheseForm)">
                            ok
                        </button>
                        <button class="btn btn-secondary box-shadow d-flex justify-content-center align-content-between"
                            (click)="_fm.cancelMapping()">
                            annuler
                        </button>
                    </div>
                </fieldset>
            </form>
            <form [formGroup]="syntheseForm">
                <div *ngFor="let theme of bibRes">
                    <fieldset>
                        <legend class="px-1">
                            {{theme.theme_name}}
                        </legend>
                        <div class="row m-0">
                            <div class="col-6" *ngFor="let field of theme.fields">
                                <div *ngIf="!field.autogenerated" class="form-group">
                                    <small>{{field.fr_label}} :</small>
                                    <select class="form-control form-control-sm" 
                                        id="{{field.name_field}}"
                                        placeholder="Open this select menu" 
                                        formControlName="{{field.name_field}}"
                                        (change)="_fm.onSelect(_fm.id_mapping, syntheseForm)"
                                        [required]=field.required>
                                        <option [value]=""></option>
                                        <option *ngFor="let column of _fm.columns" [class.isSelected]="column.selected"
                                            [value]="column.id">
                                            {{column.id}}
                                        </option>
                                    </select>
                                    <div *ngIf="field.required"
                                        [class.d-block]="syntheseForm.controls[field.name_field].hasError('required')"
                                        class="invalid-feedback">Sélectionnez
                                        {{field.name_field}}</div>
                                </div>
                                <div *ngIf="field.autogenerated" class="form-group">
                                    <label for="auto_check"> <small>{{field.fr_label}} :</small> </label>
                                    <input type="checkbox" id="auto_check" formControlName="{{field.name_field}}">
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <br>
                <div class="d-flex flex-row justify-content-between">
                    <button class="btn btn-secondary box-shadow d-flex justify-content-center align-content-between"
                        (click)="onStepBack()">
                        <i class="material-icons"> navigate_before </i>
                        Précédent
                    </button>
                    <button *ngIf="n_error_lines >= 0  && mappingRes"
                        class="btn btn-warning box-shadow d-flex justify-content-center align-content-between"
                        (click)="ErrorButtonClicked()">
                        {{n_error_lines}} lignes avec erreurs
                    </button>
                    <button *ngIf="!mappingRes" class="btn btn-success box-shadow d-flex justify-content-center align-content-between"
                        [disabled]="syntheseForm.invalid" (click)="onDataCleaning(syntheseForm.value, _fm.id_mapping)">
                        Valider le mapping
                    </button>
                    <button class="btn btn-success box-shadow d-flex justify-content-center align-content-between"
                        [disabled]="!step2_btn || isFullError" (click)='onNextStep()'>
                        Suivant
                        <i class="material-icons"> navigate_next </i>
                    </button>
                </div>
            </form>
            <!-- Error list in table -->
            <br>
            <div id="dataCleaningErrorList" *ngIf="isErrorButtonClicked">
                <div> Attention, des erreurs ont été détectées dans le fichier : </div>
                <table>
                    <thead>
                        <tr>
                            <th class="ErrorId"> Id Erreur </th>
                            <th class="ErrorType"> Type </th>
                            <th class="ErrorDescription"> Description </th>
                            <th class="ErrorColumnName"> Nom colonne</th>
                            <th class="ErrorCount"> Nombre d'erreurs</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let error of dataCleaningErrors">
                            <td> {{error.id}} </td>
                            <td> {{error.type}} </td>
                            <td> {{error.description}} </td>
                            <td> {{error.column}} </td>
                            <td> {{error.n_errors}} </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Spinner -->
    <div *ngIf="spinner" class="spinner">
        <mat-spinner class="upload-spinner" [color]="color" [diameter]="150" [strokeWidth]="12">
        </mat-spinner>
    </div>