<div class=container>
    <!-- Spinner -->
    <div *ngIf="isUploading" class="spinner">
        <mat-spinner class="upload-spinner" [color]="color" [diameter]="150" [strokeWidth]="12">
        </mat-spinner>
    </div>
    <mat-horizontal-stepper linear #stepper>
        <mat-step label="Upload du fichier" [stepControl]="uploadForm">
            <!-- STEP 1 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"> Upload du fichier </h5>
                </div>
                <div class="card-body">
                    <form [formGroup]="uploadForm" class="was-validated">
                        <div class="form-group">
                            <label>Importer un fichier :</label>
                            <div class="custom-file" id="upload_files">
                                <input class="custom-file-input" type=file (change)="onFileSelected($event)"
                                    id="selectedFile" name="file" required>
                                <label class="custom-file-label" for="selectedFile">{{fileName}}</label>
                                <label *ngIf="!fileName" class="custom-file-label" for="selectedFile"> Choisissez
                                    votre
                                    fichier</label>
                            </div>
                        </div>
                        <!-- Encoding field -->
                        <div class="form-group">
                            <label> Encodage de votre fichier :</label>
                            <select class="custom-select mr-sm-2" id="encodage" formControlName="encodage" required>
                                <option *ngFor="let encodage of IMPORT_CONFIG.ENCODAGE" [value]="encodage">
                                    {{encodage}}
                                </option>
                            </select>
                            <div class="invalid-feedback">Sélectionnez un encodage</div>
                        </div>
                        <!-- SRID field -->
                        <div class="form-group">
                            <label>SRID de vos données géographiques :</label>
                            <select class="custom-select mr-sm-2" id="srid" formControlName="srid" required>
                                <option *ngFor="let srid of IMPORT_CONFIG.SRID" [value]="srid.code">
                                    {{srid.name}}
                                </option>
                            </select>
                            <div class="invalid-feedback">Sélectionnez un SRID</div>
                        </div>
                        <!-- separator field -->
                        <div class="form-group">
                            <label>Séparateur de votre fichier :</label>
                            <select class="custom-select mr-sm-2" id="separator" formControlName="separator" required>
                                <option *ngFor="let separator of IMPORT_CONFIG.SEPARATOR" [value]="separator.code">
                                    {{separator.name}}</option>
                            </select>
                            <div class="invalid-feedback">Sélectionnez un séparateur</div>
                        </div>
                    </form>
                    <!-- Navigation buttons -->
                    <div class="navigate-btn">
                        <button type="submit"
                            class="btn btn-success box-shadow d-flex justify-content-center align-content-between"
                            (click)="onUpload(uploadForm.value, stepper)" [disabled]="step1_btn" id="validate">
                            Suivant
                            <i class="material-icons"> navigate_next </i>
                        </button>
                    </div>
                    <!-- Error list in table -->
                    <div id="errorList" *ngIf="isUserError">
                        <div> Attention, erreurs detectées dans le fichier uploadé : </div>
                        <table>
                            <thead>
                                <tr>
                                    <th class="Code"> Code </th>
                                    <th class="Message"> Message </th>
                                    <th class="MessageData"> Message Data </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let error of userErrors">
                                    <td> {{error.code}} </td>
                                    <td> {{error.message}} </td>
                                    <td> {{error.message_data}} </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </mat-step>
        <!-- STEP 2-->
        <mat-step label=" Mapping des champs" [stepControl]="syntheseForm">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"> Mapping des champs </h5>
                </div>
                <div class="card-body">

                    <!-- Choix du mapping -->

                    <form [formGroup]="selectFieldMappingForm" class="was-validated">
                        <fieldset>
                            <legend class="px-1">
                                Choix du mapping
                            </legend>
                            <div *ngIf="userFieldMapping" class="form-group">
                                <select class="form-control form-control-sm" id="fieldMappingSelection"
                                    formControlName="fieldMapping">
                                    <option selected [value]=""> </option>
                                    <option *ngFor="let data of userFieldMapping" [value]="data.id_mapping">
                                        {{data.mapping_label}}</option>
                                </select>
                            </div>
                            <button
                                class="btn btn-secondary btn-sm box-shadow d-flex justify-content-center align-content-between"
                                (click)="createMapping()">
                                Nouveau mapping
                            </button>
                            <div *ngIf="newMapping" class="d-flex flex-row justify-content-between form_group"
                                id="newMap">
                                <input type="text" class="form-control" value="Inconnu" formControlName="mappingName">
                                <button
                                    class="btn btn-success box-shadow d-flex justify-content-center align-content-between"
                                    (click)="onMappingFieldName(selectFieldMappingForm.value)">
                                    ok
                                </button>
                                <button
                                    class="btn btn-secondary box-shadow d-flex justify-content-center align-content-between"
                                    (click)="cancelMapping()">
                                    annuler
                                </button>
                            </div>
                        </fieldset>

                    </form>

                    <form [formGroup]="syntheseForm">
                        <div *ngFor="let col of IMPORT_CONFIG.MAPPING_DATA_FRONTEND">
                            <fieldset>
                                <legend class="px-1">
                                    {{col.label}}
                                </legend>
                                <div class="row m-0">
                                    <div class="col-6" *ngFor="let field of col.fields">
                                        <div class="form-group">
                                            <small>{{field.label}} :</small>
                                            <select class="form-control form-control-sm" id="{{field.label}}"
                                                placeholder="Open this select menu" formControlName="{{field.name}}"
                                                (change)="onSelect()" [required]=field.required>
                                                <option *ngFor="let column of columns"
                                                    [class.isSelected]="column.selected" [value]="column.id">
                                                    {{column.id}}
                                                </option>
                                            </select>
                                            <div *ngIf="field.required"
                                                [class.d-block]="syntheseForm.controls[field.name].hasError('required')"
                                                class="invalid-feedback">Sélectionnez
                                                {{field.label}}</div>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                        <br>
                        <div class="d-flex flex-row justify-content-between">
                            <button
                                class="btn btn-secondary box-shadow d-flex justify-content-center align-content-between"
                                (click)="onStepBack(stepper)">
                                <i class="material-icons"> navigate_before </i>
                                Précédent
                            </button>
                            <button *ngIf="n_error_lines >= 0"
                                class="btn btn-warning box-shadow d-flex justify-content-center align-content-between"
                                (click)="ErrorButtonClicked()">
                                {{n_error_lines}} lignes avec erreurs
                            </button>
                            <button
                                class="btn btn-success box-shadow d-flex justify-content-center align-content-between"
                                (click)="onMapping(syntheseForm.value, stepper, id_mapping)">
                                Valider le mapping
                            </button>
                            <button
                                class="btn btn-success box-shadow d-flex justify-content-center align-content-between"
                                [disabled]="!step2_btn || isFullError"
                                (click)="onStep3()">
                                Suivant
                                <i class="material-icons"> navigate_next </i>
                            </button>
                        </div>
                    </form>

                    <!-- Error list in table -->
                    <br>
                    <div id="dataCleaningErrorList" *ngIf="isErrorButtonClicked">

                        <div> Attention, des erreurs ont été détectées dans le fichier : </div>
                        <table>
                            <thead>
                                <tr>
                                    <th class="ErrorId"> Id Erreur </th>
                                    <th class="ErrorType"> Type </th>
                                    <th class="ErrorDescription"> Description </th>
                                    <th class="ErrorColumnName"> Nom colonne</th>
                                    <th class="ErrorCount"> Nombre d'erreurs</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let error of dataCleaningErrors">
                                    <td> {{error.id}} </td>
                                    <td> {{error.type}} </td>
                                    <td> {{error.description}} </td>
                                    <td> {{error.column}} </td>
                                    <td> {{error.n_errors}} </td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                </div>
            </div>
        </mat-step>
        <!-- STEP 3 -->
        <mat-step>
            <h4> MAPPING DES CONTENUS </h4>
            <div> Pas à faire dans iteration 1 </div>
            <div class="d-flex flex-row justify-content-between">
                <button class="btn btn-secondary box-shadow d-flex justify-content-center align-content-between"
                    (click)="tabset.select('field-mapping')">
                    <i class="material-icons"> navigate_before </i>
                    Précédent
                </button>
                <button (click)="onFinalStep()"
                    class="btn btn-success box-shadow d-flex justify-content-center align-content-between">
                    Suivant
                    <i class="material-icons"> navigate_next </i>
                </button>
            </div>
        </mat-step>
        <!-- STEP 4 -->
        <mat-step>
            <h4> TERMINER L'IMPORT </h4>
            <div *ngIf="!impatient">
                Preview des données avant import dans la synthèse
            </div>
            <div *ngIf="impatient">
                ALLONS, NE SOYEZ PAS TROP IMPATIENT !
            </div>
            <div class="d-flex flex-row justify-content-between">
                <button (click)="tabset.select('content-mapping')"
                    class="btn btn-secondary box-shadow d-flex justify-content-center align-content-between">
                    <i class="material-icons"> navigate_before </i>
                    Précédent
                </button>
                <button class="btn btn-success box-shadow d-flex justify-content-center align-content-between"
                    (click)="onFinalImport()">
                    <i class="material-icons"> done </i>
                    Importer les données dans Geonature
                </button>
            </div>
        </mat-step>
    </mat-horizontal-stepper>
    <footer>

        <div class="d-flex flex-row justify-content-between" id="bottomButtons">
            <button type="button" id="cancelImport" (click)="cancelImport()"
                class="btn btn-danger box-shadow btn-sm">Annuler l'import</button>
            <button *ngIf="!isStep1" type="button" id="importListPage" (click)="onImportList()"
                class="btn btn-secondary box-shadow btn-sm">Enregistrer et quitter</button>
        </div>

    </footer>

</div>