<div class="card main">
  <div class="card-body">
    <div class="row">
      <div class="col-12 col-lg-6">
        <div class="card content">
          <div class="card-body">
            <h5 class="card-title">
              Rapport d'import : {{ importData?.id_import }}
            </h5>
            <p class="card-text">
              <b>Jeu de données : </b><a routerLink="/metadata/dataset_detail/{{
                  importData?.id_dataset
                }}" matTooltip="Voir dans le module Metadonnées">{{ datasetName }}</a>
            </p>
            <p class="card-text">
              <b>Fichier : </b>{{ importData?.full_file_name }}
            </p>
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-lg-6">
            <div class="card content">
              <div class="card-body">
                <div class="row">
                  <div class="col-9 col-md-7">
                    <h5 class="card-title">Observations importées</h5>
                    <div class="d-flex justify-content-center">
                      <h5>
                        ({{ importData?.import_count || 0 }} ligne(s) /
                        {{ importData?.source_count }})
                      </h5>
                    </div>
                  </div>
                  <div class="col-3 col-md-5 text-center">
                    <img src="./assets/images/Donnee_icon.svg" />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card content">
              <div class="card-body">
                <div class="row">
                  <div class="col-9 col-md-7">
                    <h5 class="card-title">Taxa importés</h5>
                    <div class="d-flex justify-content-center">
                      <h5>{{ importData?.taxa_count }}</h5>
                    </div>
                  </div>
                  <div class="col-3 col-md-5 text-center">
                    <img src="./assets/images/Taxon_icon.svg" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card content">
          <div class="card-header">
            <h5 class="card-title">Description de l'import</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-6">
                <p>
                  <b>Date de soumission de l'import : </b>
                  {{ importData?.date_create_import | date: "dd/MM/yyyy" }}
                </p>
                <p><b>Auteur : </b> {{ importData?.authors_name }}</p>
                <p>
                  <b>Nombre de lignes importées : </b> ({{
                  importData?.import_count || 0
                  }}
                  /
                  {{ importData?.source_count }})
                </p>
              </div>
              <div class="col-6">
                <p><b> SRID : </b> {{ importData?.srid }}</p>
                <p><b> Encodage :</b> {{ importData?.encoding }}</p>
                <p><b> Format : </b>{{ importData?.format_source_file }}</p>
              </div>
            </div>
          </div>
        </div>
        <div class="card content">
          <div class="card-header">
            <h5 class="card-title">Correspondances</h5>
          </div>
          <div class="card-body">
            <mat-expansion-panel>
              <mat-expansion-panel-header [collapsedHeight]="expansionPanelHeight">
                <mat-panel-title>
                  <h6>Champs ({{ fieldsNb }} correspondance(s))</h6>
                </mat-panel-title>
              </mat-expansion-panel-header>
              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Champ source</th>
                    <th>Champ cible</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let field of importData?.fieldmapping | keyvalue ">
                    <td>{{ field.key }}</td>
                    <td>{{ field.value }}</td>
                  </tr>
                </tbody>
              </table>
            </mat-expansion-panel>
            <mat-expansion-panel>
              <mat-expansion-panel-header [collapsedHeight]="expansionPanelHeight">
                <mat-panel-title>
                  <h6>
                    Nomenclature ({{ matchedNomenclature?.length || 0 }}
                    correspondance(s))
                  </h6>
                </mat-panel-title>
              </mat-expansion-panel-header>
              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Champ source</th>
                    <th>Champ cible</th>
                    <th>Définition</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let field of matchedNomenclature">
                    <td>{{ field?.source?.label_default }}</td>
                    <td>{{ field?.target?.label_default }}</td>
                    <td>{{ field?.target?.definition_default }}</td>
                  </tr>
                </tbody>
              </table>
            </mat-expansion-panel>
          </div>
        </div>
        <div class="card content">
          <div class="card-header">
            <div class="d-flex justify-content-start">
              <h5 class="card-title">Données non importées - Erreurs</h5>
              <mat-icon> warning </mat-icon>
            </div>
          </div>
          <div class="card-body">
            <table class="table table-responsive table-striped table-bordered">
              <thead>
                <tr>
                  <th>Type d'erreur</th>
                  <th>Champ</th>
                  <th>Description erreur</th>
                  <th>Nombre d'erreur(s)</th>
                  <th>Numéro des lignes en erreur</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let error of importErrors">
                  <td>{{ error.type.name }}</td>
                  <td>{{ error.column }}</td>
                  <td>
                    {{ error.type.description }}
                    <i>
                      <br />
                      {{ error.comment }}</i>
                  </td>
                  <td>
                    <span *ngIf="error?.rows && error?.rows.length > 0">{{ error?.rows.length }}
                    </span>
                  </td>
                  <td>
                    <span *ngIf="error.rows.length >= 10 && !error.show">{{ error.rows.slice(0, maxErrorsLines).join(",
                      ") }} ...
                      <button mat-icon-button matTooltip="Voir plus" (click)="error.show = !error.show">
                        <mat-icon>expand_more</mat-icon>
                      </button>
                    </span>
                    <span *ngIf="error.rows.length <= 10 || error.show">{{ error.rows.join(", ") }}
                      <button mat-icon-button matTooltip="Voir moins" *ngIf="error.rows.length >= 10"
                        (click)="error.show = !error.show">
                        <mat-icon>expand_less</mat-icon>
                      </button>
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="d-flex flex-row-reverse" *ngIf="nbTotalErrors !== 0">
              <button class="mat-raised-button mat-primary" (click)="_csvExport.onCSV(importData?.id_import)">
                Exporter vos {{ nbTotalErrors }} observations invalides
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card content">
          <div class="card-body">
            <div class="d-flex justify-content-center">
              <button class="mat-raised-button mat-primary" [disabled]="loadingPdf" (click)="exportAsPDF()">
                Export PDF
                <mat-icon *ngIf="loadingPdf">
                  <mat-spinner color="warn" diameter="30"> </mat-spinner>
                </mat-icon>
              </button>
              <button [attr.disabled]="fieldsNb == 0 ? true : null" class="mat-raised-button mat-primary"
                (click)="exportCorrespondances()">
                Exporter les correspondances
              </button>
              <button [attr.disabled]="
                  matchedNomenclature === undefined ||
                  matchedNomenclature?.length == 0 ? true : null
                " class="mat-raised-button mat-primary" (click)="exportNomenclatures()">
                Exporter les nomenclatures
              </button>
              <button class="mat-raised-button mat-primary" disabled>
                Correspondances d’identifiants
              </button>
            </div>
          </div>
        </div>
        <div *ngIf="validBbox" class="card content">
          <div class="card-body">
            <div class="row">
              <div class="col-8">
                <h5 class="card-title">
                  Périmètre géographique des données importées
                </h5>
              </div>
              <div class="col-4">
                <button [disabled]="importData?.date_end_import === null" class="mat-raised-button mat-primary" (click)="goToSynthese(importData?.id_dataset)">
                  Afficher dans la synthèse
                </button>
              </div>
            </div>

            <pnx-map height="40vh" searchBar="false">
              <pnx-geojson [geojson]="validBbox" [zoomOnFirstTime]="true">
              </pnx-geojson>
            </pnx-map>
          </div>
        </div>
        <div *ngIf="doughnutChartData.length > 0" class="card content">
          <div class="card-body">
            <div class="row">
              <div class="col-7">
                <h5 class="card-title">Répartition des taxons importés</h5>
              </div>
              <div class="col-5">
                <mat-select [(value)]="rank" (selectionChange)="onRankChange($event)">
                  <mat-option *ngFor="let r of rankOptions" [value]="r">
                    {{ r }}
                  </mat-option>
                </mat-select>
              </div>
            </div>

            <div style="display: block">
              <canvas id="chart" baseChart [data]="doughnutChartData" [labels]="doughnutChartLabels"
                [chartType]="doughnutChartType" [colors]="doughnutChartColors" [options]="options">
              </canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>