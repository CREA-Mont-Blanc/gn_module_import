<div class="card main">
  <div class="card-body">
    <div class="row">
      <div class="col-12 col-lg-6">
        <div class="card content">
          <div class="card-body">
            <div class="d-flex display justify-content-between">
              <h5 class="card-title">Rapport d'import : {{ importData?.id_import }}</h5>
              <h5 class="card-title unfinished">{{ importData?.processed ? '' : 'IMPORT NON FINALISÉ'}}
              </h5>
            </div>
            <p class="card-text">
              <b>Jeu de données : </b><a routerLink="/metadata/dataset_detail/{{
                  importData?.id_dataset
                }}" matTooltip="Voir dans le module Metadonnées">{{ datasetName }}</a>
            </p>
            <p class="card-text">
              <b>Fichier : </b>{{ importData?.full_file_name }}
            </p>
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-lg-6">
            <div class="card content">
              <div class="card-body">
                <div class="row">
                  <div class="col-9 col-md-7">
                    <h5 class="card-title">Observations importées</h5>
                    <div class="d-flex justify-content-center">
                      <h5>
                        ({{ importData?.import_count || 0 }} ligne(s) /
                        {{ importData?.source_count || 0 }})
                      </h5>
                    </div>
                  </div>
                  <div class="col-3 col-md-5 text-center">
                    <img src="./assets/images/Donnee_icon.svg" />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card content">
              <div class="card-body">
                <div class="row">
                  <div class="col-9 col-md-7">
                    <h5 class="card-title">Taxons importés</h5>
                    <div class="d-flex justify-content-center">
                      <h5>{{ importData?.taxa_count }}</h5>
                    </div>
                  </div>
                  <div class="col-3 col-md-5 text-center">
                    <img src="./assets/images/Taxon_icon.svg" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card content">
          <div class="card-header">
            <h5 class="card-title">Description de l'import</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-6">
                <p>
                  <b>Date de soumission de l'import : </b>
                  {{ importData?.date_create_import | date: "dd/MM/yyyy" }}
                </p>
                <p><b>Auteur : </b> {{ importData?.authors_name }}</p>
                <p>
                  <b>Nombre de lignes importées : </b> ({{
                  importData?.import_count || 0
                  }}
                  /
                  {{ importData?.source_count || 0 }})
                </p>
              </div>
              <div class="col-6">
                <p><b> SRID : </b> {{ importData?.srid }}</p>
                <p><b> Encodage :</b> {{ importData?.encoding }}</p>
                <p><b> Format : </b>{{ importData?.format_source_file }}</p>
              </div>
            </div>
          </div>
        </div>
        <div class="card content">
          <div class="card-header">
            <h5 class="card-title">Correspondances</h5>
          </div>
          <div class="card-body">
            <mat-expansion-panel>
              <mat-expansion-panel-header [collapsedHeight]="expansionPanelHeight">
                <mat-panel-title>
                  <h6>Champs ({{ (importData?.fieldmapping || {} | keyvalue).length }} correspondance(s))</h6>
                </mat-panel-title>
              </mat-expansion-panel-header>
              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Champ source</th>
                    <th>Champ cible</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let field of importData?.fieldmapping | keyvalue ">
                    <td>{{ field.value }}</td>
                    <td>{{ field.key }}</td>
                  </tr>
                </tbody>
              </table>
            </mat-expansion-panel>
            <mat-expansion-panel>
              <mat-expansion-panel-header [collapsedHeight]="expansionPanelHeight">
                <mat-panel-title>
                  <h6>
                    Nomenclatures ({{ (importData?.contentmapping || {} | keyvalue).length }}
                    type(s de nomenclatures))
                  </h6>
                </mat-panel-title>
              </mat-expansion-panel-header>
              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Valeur source</th>
                    <th>Nomenclature</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngFor="let nomenclature_type of importData?.contentmapping | keyvalue">
                  <tr>
                    <th colspan="2">
                      <ng-container *ngIf="nomenclatures && nomenclatures.hasOwnProperty(nomenclature_type.key); then nomenclature_type_label else nomenclature_type_mnemonique"></ng-container>
                      <ng-template #nomenclature_type_label>{{ nomenclatures[nomenclature_type.key].nomenclature_type.label_default }}</ng-template>
                      <ng-template #nomenclature_type_mnemonique>{{ nomenclature_type.key }}</ng-template>
                    </th>
                  </tr>
                  <tr *ngFor="let mapping of nomenclature_type.value | keyvalue">
                    <td>{{ mapping.key }}</td>
                    <td>
                      <ng-container *ngIf="nomenclatures && nomenclatures.hasOwnProperty(nomenclature_type.key); then nomenclature_label else nomenclature_code"></ng-container>
                      <ng-template #nomenclature_label>{{ nomenclatures[nomenclature_type.key].nomenclatures[mapping.value].label_default }}</ng-template>
                      <ng-template #nomenclature_code>{{ mapping.value }}</ng-template>
                    </td>
                  </tr>
                  </ng-container>
                </tbody>
              </table>
            </mat-expansion-panel>
          </div>
        </div>
        <div class="card content">
          <div class="card-header">
            <div class="d-flex justify-content-start">
              <mat-icon> warning </mat-icon>
              &nbsp;
              <h5 class="card-title">Données invalides</h5>
            </div>
          </div>
          <div class="card-body">
            <mat-expansion-panel>
              <mat-expansion-panel-header [collapsedHeight]="expansionPanelHeight">
                <mat-panel-title>
                  <h6>{{ importErrors.length }} erreur(s)</h6>
                </mat-panel-title>
              </mat-expansion-panel-header>
              <table class="table table-responsive table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Type d'erreur</th>
                    <th>Champ</th>
                    <th>Description erreur</th>
                    <th>Nombre d'erreur(s)</th>
                    <th>Numéro des lignes en erreur</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let error of importErrors">
                    <td>{{ error.type.name }}</td>
                    <td>{{ error.column }}</td>
                    <td>
                      {{ error.type.description }}
                      <i>
                        <br />
                        {{ error.comment }}</i>
                    </td>
                    <td>
                      <span *ngIf="error?.rows && error?.rows.length > 0">{{ error?.rows.length }}
                      </span>
                    </td>
                    <td>
                      <span *ngIf="error.rows.length >= 10 && !error.show">{{ error.rows.slice(0, maxErrorsLines).join(",
                        ") }} ...
                        <button mat-icon-button matTooltip="Voir plus" (click)="error.show = !error.show">
                          <mat-icon>expand_more</mat-icon>
                        </button>
                      </span>
                      <span *ngIf="error.rows.length <= 10 || error.show">{{ error.rows.join(", ") }}
                        <button mat-icon-button matTooltip="Voir moins" *ngIf="error.rows.length >= 10"
                          (click)="error.show = !error.show">
                          <mat-icon>expand_less</mat-icon>
                        </button>
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </mat-expansion-panel>
            <mat-expansion-panel>
              <mat-expansion-panel-header [collapsedHeight]="expansionPanelHeight">
                <mat-panel-title>
                  <h6>{{ importWarnings.length }} alerte(s)</h6>
                </mat-panel-title>
              </mat-expansion-panel-header>
              <table class="table table-responsive table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Type d'erreur</th>
                    <th>Champ</th>
                    <th>Description erreur</th>
                    <th>Nombre d'erreur(s)</th>
                    <th>Numéro des lignes en erreur</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let error of importWarnings">
                    <td>{{ error.type.name }}</td>
                    <td>{{ error.column }}</td>
                    <td>
                      {{ error.type.description }}
                      <i>
                        <br />
                        {{ error.comment }}</i>
                    </td>
                    <td>
                      <span *ngIf="error?.rows && error?.rows.length > 0">{{ error?.rows.length }}
                      </span>
                    </td>
                    <td>
                      <span *ngIf="error.rows.length >= 10 && !error.show">{{ error.rows.slice(0, maxErrorsLines).join(",
                        ") }} ...
                        <button mat-icon-button matTooltip="Voir plus" (click)="error.show = !error.show">
                          <mat-icon>expand_more</mat-icon>
                        </button>
                      </span>
                      <span *ngIf="error.rows.length <= 10 || error.show">{{ error.rows.join(", ") }}
                        <button mat-icon-button matTooltip="Voir moins" *ngIf="error.rows.length >= 10"
                          (click)="error.show = !error.show">
                          <mat-icon>expand_less</mat-icon>
                        </button>
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </mat-expansion-panel>
            <div class="d-flex flex-row-reverse" *ngIf="nbTotalErrors !== 0">
              <button  mat-raised-button color="primary" (click)="_csvExport.onCSV(importData?.id_import)">
                Exporter vos {{ nbTotalErrors }} observations invalides
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card content">
          <div class="card-body">
            <div class="d-flex justify-content-center">
              <button  mat-raised-button color="primary" [disabled]="loadingPdf" (click)="exportAsPDF()">
                Rapport PDF
                <mat-icon *ngIf="loadingPdf">
                  <mat-spinner color="warn" diameter="30"> </mat-spinner>
                </mat-icon>
              </button>
              <button mat-raised-button color="primary" [disabled]="!importData?.fieldmapping"
                (click)="exportFieldMapping()">
                Exporter les correspondances des champs
              </button>
              <button mat-raised-button color="primary" [disabled]="!importData?.contentmapping"
                (click)="exportContentMapping()">
                Exporter les correspondances des nomenclatures
              </button>
            </div>
          </div>
        </div>
        <div *ngIf="validBbox" class="card content">
          <div class="card-body">
            <div class="row">
              <div class="col-8">
                <h5 class="card-title">
                  Périmètre géographique des données importées
                </h5>
              </div>
              <div class="col-4">
                <button  mat-raised-button color="primary" [disabled]="importData?.date_end_import === null" (click)="goToSynthese(importData?.id_dataset)">
                  Afficher dans la synthèse
                </button>
              </div>
            </div>

            <pnx-map height="40vh" searchBar="false">
              <pnx-geojson [geojson]="validBbox" [zoomOnFirstTime]="true">
              </pnx-geojson>
            </pnx-map>
          </div>
        </div>
        <div *ngIf="doughnutChartData.length > 0" class="card content">
          <div class="card-body">
            <div class="row">
              <div class="col-7">
                <h5 class="card-title">Répartition des taxons importés</h5>
              </div>
              <div class="col-5">
                <mat-select [(value)]="rank" (selectionChange)="onRankChange($event)">
                  <mat-option *ngFor="let r of rankOptions" [value]="r">
                    {{ r }}
                  </mat-option>
                </mat-select>
              </div>
            </div>

            <div style="display: block">
              <canvas id="chart" baseChart [data]="doughnutChartData" [labels]="doughnutChartLabels"
                [chartType]="doughnutChartType" [colors]="doughnutChartColors" [options]="options">
              </canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
